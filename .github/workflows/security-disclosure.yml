name: Security Disclosure Process

on:
  workflow_dispatch:
    inputs:
      advisoryId:
        description: "Security advisory ID to process"
        required: true
      discloseDate:
        description: "Planned disclosure date (YYYY-MM-DD)"
        required: true
      severity:
        description: "Vulnerability severity"
        required: true
        type: choice
        options:
          - critical
          - high
          - medium
          - low

jobs:
  prepare-disclosure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update advisory with disclosure date
        run: |
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/security-advisories/${{ github.event.inputs.advisoryId }} \
            -f published_at="${{ github.event.inputs.discloseDate }}T14:00:00Z"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create notification announcement
        run: |
          cat > disclosure-announcement.md << EOL
          # Security Advisory: ${{ github.event.inputs.advisoryId }}

          **Severity:** ${{ github.event.inputs.severity }}
          **Disclosure Date:** ${{ github.event.inputs.discloseDate }}

          ## Summary

          A security vulnerability has been identified and fixed in our system.
          Full details will be published on ${{ github.event.inputs.discloseDate }}.

          ## Mitigation

          Please update to the latest version which contains the security fix.

          ## Timeline

          - **Identified:** [DATE]
          - **Fixed:** [DATE]
          - **Deployed:** [DATE]
          - **Disclosure:** ${{ github.event.inputs.discloseDate }}
          EOL

          # Save this to security team's private repo for review before disclosure
          gh issue create \
            --title "📢 Upcoming Disclosure: ${{ github.event.inputs.advisoryId }}" \
            --body-file disclosure-announcement.md \
            --repo "${{ github.repository_owner }}/security-alerts" \
            --label "disclosure-pending"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  schedule-disclosure:
    needs: prepare-disclosure
    runs-on: ubuntu-latest
    steps:
      - name: Schedule disclosure activities
        run: |
          # Extract disclosure date
          DISCLOSURE_DATE="${{ github.event.inputs.discloseDate }}"

          # Calculate days until disclosure
          DAYS_UNTIL=$(( ( $(date -d "$DISCLOSURE_DATE" +%s) - $(date +%s) ) / 86400 ))

          if [ $DAYS_UNTIL -lt 0 ]; then
            echo "Error: Disclosure date is in the past"
            exit 1
          fi

          # Create timeline for disclosure process
          cat > disclosure-timeline.md << EOL
          # Security Disclosure Timeline

          **Advisory:** ${{ github.event.inputs.advisoryId }}
          **Disclosure Date:** $DISCLOSURE_DATE

          ## Pre-Disclosure Checklist

          - [ ] T-$DAYS_UNTIL days: Preparation phase begins
          - [ ] T-5 days: Final review of advisory contents
          - [ ] T-3 days: Notify affected partners (if applicable)
          - [ ] T-1 day: Final readiness check
          - [ ] T-0: Publish advisory and announcement

          ## Assigned Responsibilities

          - Advisory content: @security-lead
          - Technical verification: @security-engineer
          - Communication: @security-comms
          - Partner coordination: @security-partners
          EOL

          # Create scheduled issue for tracking
          gh issue create \
            --title "🗓️ Disclosure Timeline: ${{ github.event.inputs.advisoryId }} ($DISCLOSURE_DATE)" \
            --body-file disclosure-timeline.md \
            --repo "${{ github.repository_owner }}/security-alerts" \
            --label "disclosure-timeline"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup disclosure monitoring
        run: |
          # Create a monitoring issue to track disclosure preparations
          DISCLOSURE_DATE="${{ github.event.inputs.discloseDate }}"
          ADVISORY_ID="${{ github.event.inputs.advisoryId }}"
          SEVERITY="${{ github.event.inputs.severity }}"

          # Calculate reminders based on severity
          if [[ "$SEVERITY" == "critical" ]]; then
            REMINDER_DAYS="7,3,2,1"
          elif [[ "$SEVERITY" == "high" ]]; then
            REMINDER_DAYS="7,3,1"
          else
            REMINDER_DAYS="7,1"
          fi

          # Create dashboard comment
          cat > disclosure-dashboard.md << EOL
          # 📊 Disclosure Dashboard: $ADVISORY_ID

          **Severity:** $SEVERITY
          **Disclosure Date:** $DISCLOSURE_DATE

          ## Status

          **Current Phase:** Preparation
          **Readiness:** 🟡 In Progress

          ## Reminders

          Automatic reminders will be posted at T-$REMINDER_DAYS days.

          ## Checklist

          - [ ] Advisory draft completed and reviewed
          - [ ] Patches tested in all supported environments
          - [ ] Customer communication templates prepared
          - [ ] Partner notifications drafted (if applicable)
          - [ ] Post-disclosure support plan prepared
          EOL

          # Create tracking issue
          ISSUE_NUMBER=$(gh issue create \
            --title "📊 Disclosure Dashboard: $ADVISORY_ID ($DISCLOSURE_DATE)" \
            --body-file disclosure-dashboard.md \
            --repo "${{ github.repository_owner }}/security-alerts" \
            --label "disclosure-monitoring" \
            --json number -q '.number')

          # Set up reminder job
          gh workflow run disclosure-reminder.yml -f issueNumber=$ISSUE_NUMBER -f advisoryId=$ADVISORY_ID -f disclosureDate=$DISCLOSURE_DATE -f reminderDays=$REMINDER_DAYS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
