name: Vigor CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "Environment to deploy to"
        required: false
        default: "staging"
        type: choice
        options:
          - staging
          - production

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  AZURE_FUNCTIONAPP_NAME: vigor-functions
  AZURE_RESOURCEGROUP_NAME: vigor-rg

jobs:
  # =============================================================================
  # BACKEND CHECKS
  # =============================================================================
  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
          pip install -r requirements.txt

      - name: Run Black (Code Formatting)
        run: black --check --diff .

      - name: Run isort (Import Sorting)
        run: isort --check-only --diff .

      - name: Run Flake8 (Linting)
        run: flake8 . --count --show-source --statistics --max-line-length=120

      - name: Run MyPy (Type Checking)
        run: mypy --ignore-missing-imports --no-error-summary .
        continue-on-error: true

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    needs: backend-lint
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: backend/requirements*.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Tests with Coverage
        run: |
          pytest -v --cov=. --cov-report=xml --cov-report=html --cov-fail-under=45
        env:
          DATABASE_URL: sqlite:///./test.db
          SECRET_KEY: test-secret-key
          LLM_PROVIDER: fallback
          OPENAI_API_KEY: sk-placeholder

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  backend-security:
    name: Backend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Security Tools
        run: |
          pip install bandit safety

      - name: Run Bandit (Security Linter)
        run: bandit -r . -ll -x ./tests,./venv
        continue-on-error: true

      - name: Run Safety (Dependency Check)
        run: safety check -r requirements.txt --policy-file .safety-policy.yml
        continue-on-error: true

  # =============================================================================
  # FRONTEND CHECKS
  # =============================================================================
  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript Check
        run: npm run type-check

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Tests with Coverage
        run: npm test -- --coverage --watchAll=false
        env:
          CI: true

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          fail_ci_if_error: false

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build Application
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ vars.API_BASE_URL || 'https://vigor-functions.azurewebsites.net' }}
          VITE_AZURE_AD_CLIENT_ID: be183263-80c3-4191-bc84-2ee3c618cbcd
          VITE_AZURE_AD_TENANT_ID: common

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # =============================================================================
  # INFRASTRUCTURE VALIDATION
  # =============================================================================
  infrastructure-validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true

      - name: Validate Bicep Templates
        run: |
          az bicep build --file infrastructure/bicep/main-modernized.bicep
        continue-on-error: true

  # =============================================================================
  # E2E TESTS (On PR and Main Branch)
  # =============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [frontend-build, backend-test]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Run E2E Tests
        run: npx playwright test --project=chromium
        continue-on-error: true

      - name: Upload E2E Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-test-results
          path: frontend/test-results
          retention-days: 7

  # =============================================================================
  # DEPLOYMENT (Only on main branch push)
  # =============================================================================
  deploy-functions:
    name: Deploy Azure Functions
    runs-on: ubuntu-latest
    needs: [backend-test, backend-security, infrastructure-validate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure Functions Core Tools
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
          sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
          sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-ubuntu-$(lsb_release -cs)-prod $(lsb_release -cs) main" > /etc/apt/sources.list.d/dotnetdev.list'
          sudo apt-get update
          sudo apt-get install azure-functions-core-tools-4

      - name: Prepare Functions Package
        run: |
          cd functions-modernized
          pip install -r requirements.txt -t .python_packages/lib/site-packages

      - name: Deploy to Azure Functions
        run: |
          cd functions-modernized
          func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --python

      - name: Verify Deployment
        run: |
          echo "Waiting for function app to warm up..."
          sleep 30
          curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health || echo "Health check pending..."

  deploy-frontend:
    name: Deploy Static Web App
    runs-on: ubuntu-latest
    needs: [frontend-build, e2e-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          skip_app_build: true

  # =============================================================================
  # POST-DEPLOYMENT VALIDATION
  # =============================================================================
  post-deploy-validation:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-frontend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Health Check - Backend API
        run: |
          echo "Checking backend API health..."
          curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/health || exit 1

      - name: Health Check - Frontend
        run: |
          echo "Checking frontend availability..."
          # Add frontend URL when Static Web App is deployed
          echo "Frontend health check pending configuration"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API**: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: Pending Static Web App URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
