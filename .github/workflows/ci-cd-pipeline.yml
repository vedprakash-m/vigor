name: Vigor CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_infrastructure:
        description: "Deploy infrastructure (Bicep)"
        type: boolean
        default: false

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  AZURE_FUNCTIONAPP_NAME: vigor-functions
  AZURE_RESOURCEGROUP_NAME: vigor-rg

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # QUALITY CHECKS (Run in parallel for speed)
  # =============================================================================
  backend-quality:
    name: Backend Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: functions-modernized
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: functions-modernized/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort bandit
          pip install -r requirements.txt

      - name: Code Quality Checks
        run: |
          echo "::group::Black (Formatting)"
          black --check --diff . || echo "::warning::Black found formatting issues"
          echo "::endgroup::"

          echo "::group::isort (Import Sorting)"
          isort --check-only --diff . || echo "::warning::isort found import issues"
          echo "::endgroup::"

          echo "::group::Flake8 (Linting)"
          flake8 . --count --show-source --statistics --max-line-length=120 --exclude=.venv,__pycache__
          echo "::endgroup::"

          echo "::group::Bandit (Security)"
          bandit -r . -ll -x ./.venv,./tests,./test_*.py || echo "::warning::Bandit found security issues"
          echo "::endgroup::"

  frontend-quality:
    name: Frontend Quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint & Type Check
        run: |
          npm run lint
          npm run type-check

      - name: Run Tests
        run: npm test -- --watchAll=false --passWithNoTests
        env:
          CI: true

      - name: Build
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.API_URL || 'https://vigor-functions.azurewebsites.net' }}
          VITE_AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID || 'be183263-80c3-4191-bc84-2ee3c618cbcd' }}
          VITE_AZURE_AD_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID || 'be183263-80c3-4191-bc84-2ee3c618cbcd' }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 3

  infrastructure-validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate Bicep
        run: az bicep build --file infrastructure/bicep/main-modernized.bicep --stdout > /dev/null

  # =============================================================================
  # DEPLOYMENT (Only on main branch push, after quality checks pass)
  # =============================================================================
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality, infrastructure-validate]
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.deploy_infrastructure == 'true'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        run: |
          cd infrastructure/bicep
          az deployment group create \
            --resource-group ${{ env.AZURE_RESOURCEGROUP_NAME }} \
            --name "vigor-$(date +%Y%m%d-%H%M%S)" \
            --template-file main-modernized.bicep \
            --parameters parameters-modernized.bicepparam

  deploy-functions:
    name: Deploy Functions
    runs-on: ubuntu-latest
    needs: [backend-quality, infrastructure-validate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Deploy to Azure Functions
        run: |
          cd functions-modernized
          pip install -r requirements.txt -t .python_packages/lib/site-packages
          func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --python

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [frontend-quality]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v6

      - name: Download Build
        uses: actions/download-artifact@v7
        with:
          name: frontend-build
          path: frontend/dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          skip_app_build: true

  # =============================================================================
  # SUMMARY
  # =============================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-frontend]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Vigor Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Functions | ${{ needs.deploy-functions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**API:** https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
