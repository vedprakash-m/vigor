name: Vigor CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  AZURE_FUNCTIONAPP_NAME: vigor-functions
  AZURE_RESOURCEGROUP_NAME: vigor-rg

jobs:
  # =============================================================================
  # BACKEND CHECKS (Azure Functions)
  # =============================================================================
  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: functions-modernized
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: functions-modernized/requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
          pip install -r requirements.txt

      - name: Run Black (Code Formatting)
        run: black --check --diff .
        continue-on-error: true

      - name: Run isort (Import Sorting)
        run: isort --check-only --diff .
        continue-on-error: true

      - name: Run Flake8 (Linting)
        run: flake8 . --count --show-source --statistics --max-line-length=120 --exclude=.venv,__pycache__
        continue-on-error: true

  backend-security:
    name: Backend Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: functions-modernized
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Security Tools
        run: pip install bandit safety

      - name: Run Bandit (Security Linter)
        run: bandit -r . -ll -x ./.venv,./tests,./test_*.py
        continue-on-error: true

      - name: Run Safety (Dependency Check)
        run: safety check -r requirements.txt
        continue-on-error: true

  # =============================================================================
  # FRONTEND CHECKS
  # =============================================================================
  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript Check
        run: npm run type-check
        continue-on-error: true

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: npm test -- --watchAll=false --passWithNoTests
        env:
          CI: true

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    needs: frontend-lint
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build Application
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.API_URL || 'https://vigor-functions.azurewebsites.net' }}
          VITE_AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID || '' }}

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist
          retention-days: 7

  # =============================================================================
  # INFRASTRUCTURE VALIDATION
  # =============================================================================
  infrastructure-validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Bicep Syntax
        run: |
          az bicep build --file infrastructure/bicep/main-modernized.bicep --stdout > /dev/null
        continue-on-error: true

  # =============================================================================
  # DEPLOYMENT (Only on main branch push)
  # =============================================================================
  deploy-functions:
    name: Deploy Azure Functions
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-security, infrastructure-validate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        continue-on-error: true

      - name: Install Azure Functions Core Tools
        run: npm install -g azure-functions-core-tools@4 --unsafe-perm true

      - name: Prepare Functions Package
        run: |
          cd functions-modernized
          pip install -r requirements.txt -t .python_packages/lib/site-packages

      - name: Deploy to Azure Functions
        run: |
          cd functions-modernized
          func azure functionapp publish ${{ env.AZURE_FUNCTIONAPP_NAME }} --python
        continue-on-error: true

  deploy-frontend:
    name: Deploy Static Web App
    runs-on: ubuntu-latest
    needs: [frontend-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend/dist"
          skip_app_build: true
        continue-on-error: true

  # =============================================================================
  # POST-DEPLOYMENT SUMMARY
  # =============================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-functions, deploy-frontend]
    if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸš€ Vigor Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources:" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API**: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: Azure Functions + Cosmos DB + OpenAI gpt-5-mini" >> $GITHUB_STEP_SUMMARY
